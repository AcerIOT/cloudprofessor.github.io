<html>
<!-- Draggable List -->
<!--2017/01/15 Mark Yang -->
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Draggable List with Handles</title>
<head>
    <link rel="stylesheet" href="css/main.css">
</head>

<body style="font-family:arial;width:100%">
    <section>
        <h2>Draggable List With Handles</h2>
       
        <ul class="handles list">
            <li id="item_01" class="dragitem"><span>::</span> Lesson 1 <a href="http://www.google.com">  google.com</a></li>
            <li id="item_02" class="dragitem"><span>::</span> Lesson 2 </li>
            <li id="item_03" class="dragitem"><span>::</span> Lesson 3 </li>
            <li id="item_04" class="dragitem"><span>::</span> Lesson 4 </li>
            <li id="item_05" class="dragitem"><span>::</span> Lesson 5 </li>
            <li id="item_06" class="dragitem"><span>::</span> Lesson 6 </li>
            <li id="item_07" class="dragitem"><span>::</span> Lesson 7 </li>
            <li id="item_08" class="dragitem"><span>::</span> Lesson 8 </li>
            <li id="item_09" class="dragitem"><span>::</span> Lesson 9 </li>
            <li id="item_10" class="dragitem"><span>::</span> Lesson 10 </li>
        </ul>
    </section>



<script>
var dragClass = ".dragitem";
var dragOriginalElemsHTML = [];
var dragElem = {};

function handleDragStart (event){
    console.log ("------------------------------");
    console.log ('handleDragStart() ' + event.target.id);

    // make a copy of the list
    var listElems = document.querySelectorAll (dragClass);
    console.log ("handleDragStart() - item count: " + listElems.length);

    dragOriginalElemsHTML = [];
    for (var i=0; i<listElems.length; i++) {
        listElems[i].idx = i;
        dragOriginalElemsHTML.push ({"elem":listElems[i], "idx":i, "innerHTML":listElems[i].innerHTML});
    }

    // store a ref. on the dragged elem
    dragElem.idx = event.target.idx;
    dragElem.innerHTML = event.target.innerHTML;

    console.log ("dragElem.idx: " + dragElem.idx);

    // make it half transparent
    event.target.style.opacity = .5;

}

function handleDragEnd (event){
    console.log ("------------------------------");
    console.log ('handleDragEnd()' + event.target.idx);
    dragStartElems = {};
    dragElem = {};

    // remove hover placeholder class from all elems
    var listElems = document.querySelectorAll (dragClass);
    for (var i=0; i<listElems.length; i++) {
        listElems[i].classList.remove ('hover_placeholder');
    }

    // reset the transparency
    event.target.style.opacity = "";
}

function handleDragEnter (event){
    console.log ("------------------------------");
    console.log ('handleDragEnter()' + event.target.idx);

    var dragElemIdx = 0;
    var dragEneterElemIdx = 0;
    var newListElems = [];
    for (var i=0; i<dragOriginalElemsHTML.length; i++) {
        newListElems.push ({"elem":dragOriginalElemsHTML.elem, "idx":dragOriginalElemsHTML[i].idx, "innerHTML":dragOriginalElemsHTML[i].innerHTML});

        if (dragOriginalElemsHTML[i].idx == dragElem.idx) {
            dragElemIdx = i;
        }

        if (dragOriginalElemsHTML[i].idx == this.idx) {
            dragEneterElemIdx = i;
        }
    }

    // remove drag item from the new list
    newListElems.splice (dragElemIdx, 1);

    // adds back the drag item to the new list in current drag position
    newListElems.splice (dragEneterElemIdx, 0, dragElem);

    // output to html
    var listElems = document.querySelectorAll (dragClass);
    for (var i=0; i<listElems.length; i++) {

        //listElems[i].id = newListElems[i].id;
        listElems[i].innerHTML = newListElems[i].innerHTML;

        if (listElems[i].idx == this.idx) {
            listElems[i].classList.add ('hover_placeholder');
        }
    }
    
    // prevent default to allow drop
    event.preventDefault();
    
}

function handleDragLeave (event){
    console.log ("------------------------------");
    console.log ('handleDragLeave(): ' + event.target.idx);

    this.classList.remove ('hover_placeholder');

    // prevent default to allow drop
    event.preventDefault();
}

function handleDragOver (event){
    //console.log ("------------------------------");
    //console.log ('handleDragOver()');
    if (dragElem != event.target) {
        console.log ('handleDragOver()' + event.target.idx);
    }

    // prevent default to allow drop
    event.preventDefault();
}


//----- touch handlers
var startTouchElem= {};
var curTouchElem = {};

function findListElemByPageXY (listElems, pageX, pageY) {
    for (var i=0; i<listElems.length; i++){
        var elem = listElems[i].elem;
        //var elemBoundRect = elem.getBoundingClientRect();

        console.log ('elem['+i+'].id: ' + elem.id);
        console.log ('elem['+i+'].idx: ' + elem.idx);
        console.log ('elem['+i+']: offsetLeft-' + elem.offsetLeft + ', offsetTop-' + elem.offsetTop);

        // finds elem.top & elem.left in the page
        var top    = elem.offsetTop;
        var left   = elem.offsetLeft;
        var right  = left + elem.offsetWidth;
        var bottom = top  + elem.offsetHeight;

        while(elem.offsetParent) {
            elem  = elem.offsetParent;

            top  += elem.offsetTop;
            left += elem.offsetLeft;

            bottom += elem.offsetTop;
            right  += elem.offsetLeft;
        }

        console.log ('boundRect['+i+']: l-' + left + ', r-' + right + ', t-' + top + ', b-' + bottom);

        if ( (pageX >= left && pageX <= right) &&
             (pageY >= top  && pageY <= bottom)) {
            return listElems[i];
        }
    }

    return null;
}

function handleTouchStart (event){
    console.log ("------------------------------");
    console.log ('handleTouchStart(): ' + event.target.id);

    curTouchElem = null;
    //handleDragStart (event);

    // make a copy of the list
    var listElems = document.querySelectorAll (dragClass);

    dragOriginalElemsHTML = [];
    for (var i=0; i<listElems.length; i++) {
        listElems[i].idx = i;
        dragOriginalElemsHTML.push ({"elem":listElems[i], "idx":i, "innerHTML":listElems[i].innerHTML});
    }
    
    // only supports 1 touch point
    if (event.targetTouches.length == 1) {
        var touch = event.targetTouches[0];

        var touchElem = findListElemByPageXY(dragOriginalElemsHTML, touch.pageX, touch.pageY);

        if (touchElem != null) {
            startTouchElem.elem = touchElem.elem;
            startTouchElem.idx = touchElem.idx;
            startTouchElem.innerHTML = event.target.innerHTML;

            console.log ('handleTouchStart(): startTouchElem: ' + startTouchElem);
        }
    }

    // prevent default to allow drop
    event.preventDefault();
}

function handleTouchEnd (event){
    console.log ("------------------------------");
    console.log ('handleTouchEnd(): ' + event.target.idx);

    handleDragEnd(event);

    curTouchElem = null;

    // prevent default to allow drop
    event.preventDefault();
}

function handleTouchCancel (event){
    console.log ("------------------------------");
    console.log ('handleTouchCancel(): ' + event.target.idx);

    curTouchElem = null;

    // prevent default to allow drop
    event.preventDefault();
}

function handleTouchMove (event){
    console.log ("------------------------------");
    console.log ('handleTouchMove(): ' + event.target.idx);

    // only supports 1 touch point
    if (event.targetTouches.length == 1) {
        var touch = event.targetTouches[0];
        console.log ('handleTouchMove(): x:' + touch.pageX + "       y:" + touch.pageY);
        console.log ('handleTouchMove(): clientLeft:' + this.getBoundingClientRect().left + "       clientTop:" + this.getBoundingClientRect().top);

        var touchElem = findListElemByPageXY(dragOriginalElemsHTML, touch.pageX, touch.pageY);

        if (touchElem != null && touchElem != startTouchElem) {
            handleTouchEnter (event, touchElem);
            curTouchElem = touchElem;
        }
        // Place element where the finger is
        //this.style.left = touch.pageX + 'px';
        //this.style.top = touch.pageY + 'px';
    }

    // prevent default to allow drop
    event.preventDefault();
}

function handleTouchEnter (event, curTouchElem){
    console.log ("------------------------------");
    console.log ('handleTouchEnter()');

    var startTouchElemIdx = 0;
    var touchEneterElemIdx = 0;
    var newListElems = [];
    for (var i=0; i<dragOriginalElemsHTML.length; i++) {
        newListElems.push ({"idx":dragOriginalElemsHTML.idx, "id":dragOriginalElemsHTML[i].id, "innerHTML":dragOriginalElemsHTML[i].innerHTML});

        if (dragOriginalElemsHTML[i].idx == startTouchElem.idx) {
            startTouchElemIdx = i;
        }

        if (dragOriginalElemsHTML[i].idx == curTouchElem.idx) {
            touchEneterElemIdx = i;
        }
    }

    // remove drag item from the new list
    newListElems.splice (startTouchElemIdx, 1);

    // adds back the drag item to the new list in current drag position
    newListElems.splice (touchEneterElemIdx, 0, startTouchElem);

    // output to html
    var listElems = document.querySelectorAll (dragClass);
    for (var i=0; i<listElems.length; i++) {

        //listElems[i].id = newListElems[i].id;
        listElems[i].innerHTML = newListElems[i].innerHTML;

        if (listElems[i].idx == this.idx) {
            listElems[i].classList.add ('hover_placeholder');
        }
    }
}

// set all items
function initDraggableList (classname) {
    var dragElems = document.querySelectorAll (classname);
    for (var i = 0; i < dragElems.length; i++) {
        elem = dragElems[i];

        // setup drag-drop events
        elem.setAttribute ("draggable", true);

        elem.addEventListener("dragstart", handleDragStart, false);
        elem.addEventListener("dragend"  , handleDragEnd, false);
        elem.addEventListener("dragenter", handleDragEnter, false);
        elem.addEventListener("dragleave", handleDragLeave, false);
        elem.addEventListener("dragover" , handleDragOver, false);

        // setup touch events
        elem.addEventListener("touchstart" , handleTouchStart, false);
        elem.addEventListener("touchend"   , handleTouchEnd, false);
        elem.addEventListener("touchcancel", handleTouchCancel, false);
        elem.addEventListener("touchmove"  , handleTouchMove, false);
    }
}

initDraggableList (dragClass);

</script>

</body>

</html>
